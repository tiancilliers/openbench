<!DOCTYPE html>
<html>
<head>
    <title>OpenBench (Alpha)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4">OpenBench (Alpha)</h1>
        <div id="loading" class="text-center text-blue-500 font-semibold">Loading...</div>
        <table id="rankingTable" class="hidden w-full border-collapse border border-gray-300 mt-4">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-4 py-2">Model</th>
                    <th class="border border-gray-300 px-4 py-2">Score</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <script>
        async function fetchJSON(file) {
            const response = await fetch(file);
            return response.json();
        }

        async function readAllBenches(filter) {
            const dataList = await fetchJSON('data_list.json');
            let sources = [];
            for (let filename of dataList[filter.class]) {
                let source = await fetchJSON(filename);
                sources.push(source);
            }
            return sources.flatMap(source => 
                source.class === filter.class ? source.benchmarks.filter(bench => 
                    Object.entries(filter.subfilters).every(([key, value]) => bench[key] === value)
                ) : []
            );
        }

        function rankRelative(benchmarks, unity) {
            let models = [...new Set(benchmarks.flatMap(bench => bench.models))];
            let benchmarkSumSq = benchmarks.map(bench => bench.results.reduce((sum, result) => sum + result ** 2, 0));
            let benchmarkDicts = benchmarks.map(bench => Object.fromEntries(bench.models.map((model, i) => [model, bench.results[i]])));
            let benchmarkMatr = models.map(model => benchmarkDicts.map(bench => bench[model] || null));
            
            let solveMatr = Array(models.length).fill(null).map(() => Array(models.length).fill(0));
            for (let i = 0; i < models.length; i++) {
                for (let j = 0; j < models.length; j++) {
                    solveMatr[i][j] = benchmarks.reduce((sum, _, k) => {
                        let valI = benchmarkMatr[i][k];
                        let valJ = benchmarkMatr[j][k];
                        if (valI !== null && valJ !== null) {
                            let normI = (valI ** 2 / benchmarkSumSq[k]) - 1;
                            if (i === j) {
                                return sum + normI ** 2;
                            } else {
                                return sum + normI * valI * valJ / benchmarkSumSq[k];
                            }
                        }
                        return sum;
                    }, 0);
                }
            }
            
            let svdResult = numeric.svd(solveMatr);
            console.log(svdResult);
            let lastColIndex = svdResult.V[0].length - 1;
            let solveRes = svdResult.V.map(row => row[lastColIndex] / svdResult.V[models.indexOf(unity)][lastColIndex]);
            return Object.fromEntries(models.map((model, i) => [model, solveRes[i]]));
        }

        (async function() {
            let benchmarks = await readAllBenches({ class: "graphics", subfilters: { type: "gaming-average", raytracing: false } });
            let ranking = rankRelative(benchmarks, "RTX 5070");
            let sortedRanking = Object.entries(ranking).sort((a, b) => b[1] - a[1]);
            
            document.getElementById("loading").classList.add("hidden");
            let table = document.getElementById("rankingTable");
            table.classList.remove("hidden");
            let tbody = table.querySelector("tbody");
            sortedRanking.forEach(([model, score]) => {
                let row = document.createElement("tr");
                row.innerHTML = `<td class="border border-gray-300 px-4 py-2">${model}</td><td class="border border-gray-300 px-4 py-2">${score.toFixed(4)}</td>`;
                tbody.appendChild(row);
            });
        })();
    </script>
</body>
</html>
